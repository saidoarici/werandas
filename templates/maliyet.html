<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Maliyet Hesaplama</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        input[type="number"], input[type="text"] {
            min-width: 100px;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <h2 class="text-center mb-4">Yeni Maliyet Hesaplama</h2>

    <form id="costForm">
        <table class="table table-bordered text-center align-middle">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Ürün</th>
                    <th>Ölçü (EnxBoy)</th>
                    <th>Adet</th>
                    <th>Ürün Maliyeti</th>
                    <th>Montaj Maliyeti</th>
                    <th>Maliyet Toplam</th>
                    <th>Kar Oranı (%)</th>
                    <th>Karlı Satış</th>
                </tr>
            </thead>
            <tbody id="costTableBody">
                <!-- JS ile satırlar eklenecek -->
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="6" class="text-end"><strong>Toplam:</strong></td>
                    <td id="totalCost">0</td>
                    <td></td>
                    <td id="totalSales">0</td>
                </tr>
            </tfoot>
        </table>

        <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-secondary" onclick="addRow()">Satır Ekle</button>
            <div>
                <button type="button" class="btn btn-success" onclick="saveData()">Kaydet</button>
                <a href="/download-pdf" class="btn btn-danger">PDF İndir</a>
            </div>
        </div>
    </form>
</div>

<script>
    let rowCount = 0;

    function addRow() {
        rowCount++;
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${rowCount}</td>
            <td><input type="text" class="form-control" name="product"></td>
            <td><input type="text" class="form-control" name="size"></td>
            <td><input type="number" class="form-control" name="quantity" value="1" min="1" onchange="calculate()"></td>
            <td><input type="number" class="form-control" name="unit_cost" value="0" onchange="calculate()"></td>
            <td><input type="number" class="form-control" name="assembly_cost" value="0" onchange="calculate()"></td>
            <td class="total_cost">0</td>
            <td><input type="number" class="form-control" name="profit_rate" value="20" onchange="calculate()"></td>
            <td class="sale_price">0</td>
        `;
        document.getElementById("costTableBody").appendChild(row);
        calculate();
    }

    function calculate() {
        let totalCost = 0, totalSales = 0;
        document.querySelectorAll("#costTableBody tr").forEach(row => {
            const adet = parseFloat(row.querySelector('[name="quantity"]').value) || 0;
            const a = parseFloat(row.querySelector('[name="unit_cost"]').value) || 0;
            const b = parseFloat(row.querySelector('[name="assembly_cost"]').value) || 0;
            const k = parseFloat(row.querySelector('[name="profit_rate"]').value) || 0;

            const cost = (a + b) * adet;
            const sale = cost * (1 + k / 100);

            row.querySelector(".total_cost").textContent = cost.toFixed(2);
            row.querySelector(".sale_price").textContent = sale.toFixed(2);

            totalCost += cost;
            totalSales += sale;
        });
        document.getElementById("totalCost").textContent = totalCost.toFixed(2);
        document.getElementById("totalSales").textContent = totalSales.toFixed(2);
    }

    function saveData() {
        const rows = document.querySelectorAll("#costTableBody tr");
        const data = [];

        rows.forEach(row => {
            data.push({
                product: row.querySelector('[name="product"]').value,
                size: row.querySelector('[name="size"]').value,
                quantity: parseInt(row.querySelector('[name="quantity"]').value),
                unit_cost: parseFloat(row.querySelector('[name="unit_cost"]').value),
                assembly_cost: parseFloat(row.querySelector('[name="assembly_cost"]').value),
                profit_rate: parseFloat(row.querySelector('[name="profit_rate"]').value),
                total_cost: parseFloat(row.querySelector('.total_cost').textContent),
                sale_price: parseFloat(row.querySelector('.sale_price').textContent)
            });
        });

        fetch('/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        }).then(response => response.json())
          .then(res => {
              if (res.status === 'success') {
                  alert('Veriler başarıyla kaydedildi!');
              }
          });
    }

    window.onload = () => {
        for (let i = 0; i < 3; i++) addRow();
    };
</script>
</body>
</html>